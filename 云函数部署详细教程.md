# 🚀 云函数部署和环境变量配置详细教程

## 📋 前置条件

1. ✅ 已在微信开发者工具中导入 `miniprogram/` 目录
2. ✅ 已注册微信小程序账号并获得 AppID
3. ✅ 已开通微信云开发服务

## 🔧 第一步：开通云开发服务

### 1.1 在微信开发者工具中开通云开发

1. **打开微信开发者工具**
2. **导入项目** - 选择 `miniprogram/` 目录
3. **点击工具栏中的"云开发"按钮**
   - 位置：工具栏 → 云开发
   - 如果没有看到，确保已正确配置 AppID

4. **开通云开发**
   - 点击"开通"
   - 选择环境名称（如：`prod-xxx`）
   - 选择套餐（免费版足够测试使用）
   - 等待开通完成

### 1.2 获取环境ID
开通后会得到一个环境ID，类似：`cloud1-xxx-xxx`

## 🔧 第二步：部署云函数

### 2.1 在微信开发者工具中创建云函数

1. **右键点击项目根目录**
2. **选择"新建" → "云函数"**
3. **输入云函数名称**: `appraiseBeads`
4. **选择环境**: 选择刚才创建的云开发环境

### 2.2 替换云函数代码

1. **删除自动生成的文件**
   - 删除 `cloudfunctions/appraiseBeads/` 下的默认文件

2. **复制我们准备的代码**
   ```bash
   # 将项目中的云函数代码复制到微信开发者工具生成的目录
   # 源目录：项目根目录/cloudfunctions/appraiseBeads/
   # 目标目录：微信开发者工具项目/cloudfunctions/appraiseBeads/
   ```

3. **确保文件结构正确**
   ```
   cloudfunctions/
   └── appraiseBeads/
       ├── index.js      # 主逻辑文件
       ├── package.json  # 依赖配置
       └── config.json   # 云函数配置
   ```

### 2.3 安装依赖并部署

1. **右键点击 `appraiseBeads` 云函数文件夹**
2. **选择"在终端中打开"**
3. **安装依赖**
   ```bash
   npm install
   ```
4. **右键点击 `appraiseBeads` 云函数文件夹**
5. **选择"上传并部署：云端安装依赖"**
6. **等待部署完成**

## 🔧 第三步：配置环境变量

### 3.1 在微信云开发控制台配置

1. **打开云开发控制台**
   - 方式1：微信开发者工具 → 云开发 → 控制台
   - 方式2：直接访问 [https://console.cloud.tencent.com/tcb](https://console.cloud.tencent.com/tcb)

2. **选择对应的环境**
   - 点击你创建的云开发环境

3. **进入环境变量设置**
   - 左侧菜单 → 环境 → 环境变量
   - 或者：设置 → 环境变量

4. **添加环境变量**
   - 点击"添加变量"
   - 变量名：`AI_API_KEY`
   - 变量值：你的AI服务API密钥（如：智谱AI、百度文心一言等的API Key）
   - 点击"确定"

### 3.2 其他可选环境变量

根据需要添加以下环境变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `AI_API_KEY` | AI服务API密钥 | `sk-xxx...` |
| `AI_BASE_URL` | AI服务基础URL | `https://open.bigmodel.cn/api/paas/v4/` |
| `AI_MODEL` | 使用的AI模型 | `glm-4v` |
| `DEBUG_MODE` | 调试模式 | `true` |

## 🔧 第四步：测试云函数

### 4.1 在云开发控制台测试

1. **进入云函数管理**
   - 云开发控制台 → 云函数 → 函数列表

2. **找到 `appraiseBeads` 函数**
   - 点击函数名称进入详情

3. **测试函数**
   - 点击"测试"标签
   - 输入测试数据：
   ```json
   {
     "fileID": "cloud://xxx.jpg",
     "action": "analyze"
   }
   ```
   - 点击"执行"
   - 查看返回结果

### 4.2 在小程序中测试

1. **在微信开发者工具中运行小程序**
2. **点击拍照或选择图片功能**
3. **查看控制台输出**
4. **确认云函数调用成功**

## 🔧 第五步：更新小程序配置

### 5.1 更新 app.js 中的环境ID

```javascript
// miniprogram/app.js
wx.cloud.init({
  env: 'your-env-id', // 替换为你的环境ID
  traceUser: true
})
```

### 5.2 确认云函数调用代码

```javascript
// miniprogram/utils/api.js
wx.cloud.callFunction({
  name: 'appraiseBeads', // 确保函数名正确
  data: {
    fileID: fileID,
    action: 'analyze'
  }
})
```

## 📱 完整操作流程图

```
1. 微信开发者工具导入项目
   ↓
2. 开通云开发服务
   ↓
3. 创建云函数 appraiseBeads
   ↓
4. 复制代码到云函数目录
   ↓
5. npm install 安装依赖
   ↓
6. 上传并部署云函数
   ↓
7. 云开发控制台配置环境变量
   ↓
8. 测试云函数功能
   ↓
9. 在小程序中测试完整流程
```

## ⚠️ 常见问题和解决方案

### 问题1：云函数部署失败
**解决方案**：
- 检查 `package.json` 格式是否正确
- 确保网络连接正常
- 重试部署操作

### 问题2：环境变量不生效
**解决方案**：
- 重新部署云函数
- 检查变量名是否正确
- 确认在正确的环境中配置

### 问题3：云函数调用失败
**解决方案**：
- 检查环境ID是否正确
- 确认云函数名称匹配
- 查看云函数日志排查错误

## 🎯 验证部署成功

部署成功后，你应该能看到：

1. ✅ 云开发控制台中显示 `appraiseBeads` 函数
2. ✅ 环境变量中有 `AI_API_KEY` 配置
3. ✅ 小程序可以正常调用云函数
4. ✅ AI分析功能正常工作

## 📞 需要帮助？

如果在部署过程中遇到问题，请提供：
1. 具体的错误信息
2. 操作步骤截图
3. 云函数日志内容

我会帮您逐步解决！