# 云函数调试指南

## 🚨 当前问题分析

**问题现象：**
```javascript
// 期望返回：
{
  success: true,
  data: {
    material: "小叶紫檀",
    estimate: "¥800-3000",
    // ... 其他分析数据
  }
}

// 实际返回：
{
  action: "analyze",
  fileID: "cloud://...",
  tcbContext: {...},
  userInfo: {...}
}
```

**问题原因：**
云函数没有正确返回分析结果，可能是：
1. OpenRouter API密钥未配置
2. API调用失败
3. 返回格式错误

## 🔧 调试步骤

### 第1步：查看云函数日志
1. 微信开发者工具 → 云开发 → 云函数
2. 点击 `appraiseBads` 函数
3. 查看 **"调用日志"** 选项卡
4. 找到最近的调用记录，查看详细日志

### 第2步：检查环境变量配置
确认以下环境变量是否正确配置：
```
OPENROUTER_API_KEY = sk-or-v1-你的API密钥
OPENROUTER_BASE_URL = https://openrouter.ai/api/v1/chat/completions
MODEL_NAME = qwen/qwen-vl-plus
```

### 第3步：重新部署云函数
1. 右键点击 `miniprogram/cloudfunctions/appraiseBads`
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

### 第4步：测试调试版本
运行以下测试代码查看详细日志：

```javascript
wx.cloud.callFunction({
  name: 'appraiseBads',
  data: { action: 'materials' }
}).then(res => {
  console.log('材质测试结果：', res.result)
}).catch(err => {
  console.error('材质测试失败：', err)
})
```

## 🎯 预期结果

### 成功的材质查询应该返回：
```javascript
{
  success: true,
  data: [
    {
      name: "小叶紫檀",
      description: "帝王之木，质地坚硬，纹理细腻",
      priceRange: [800, 3000],
      features: ["密度高", "油性足", "香味淡雅", "纹理细腻"]
    },
    // ... 更多材质
  ],
  error: null
}
```

### 成功的图片分析应该返回：
```javascript
{
  success: true,
  data: {
    material: "小叶紫檀",
    materialDescription: "帝王之木，质地坚硬，纹理细腻",
    craft: "手工打磨",
    quality: "品质良好",
    estimate: "¥1200 - ¥2800",
    comment: "基于图片特征分析...",
    confidence: 85,
    features: ["纹理清晰", "工艺精良", "品相完好"],
    careInstructions: "避免接触化学物品...",
    culturalBackground: "佛珠作为佛教文化的重要载体...",
    analysisTime: "2025-01-21T02:19:27.000Z",
    aiService: "openrouter-qwen-vl" // 或 "fallback"
  },
  error: null
}
```

## 🔍 常见问题排查

### Q1: 返回数据格式错误
**检查：** 云函数是否正确返回了 `{success, data, error}` 格式

### Q2: API密钥未生效
**解决：** 重新配置环境变量，等待2-3分钟生效

### Q3: 网络请求失败
**检查：** 云函数日志中是否有网络错误信息

### Q4: 备用方案未触发
**检查：** `getFallbackResult()` 函数是否正常工作

## 📋 下一步操作

1. **查看云函数日志** - 找出具体错误原因
2. **重新部署云函数** - 确保最新代码生效
3. **测试材质查询** - 验证基础功能
4. **测试图片分析** - 验证AI功能

请按照上述步骤进行调试，并告诉我云函数日志中显示了什么错误信息！